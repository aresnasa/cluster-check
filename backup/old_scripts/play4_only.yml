---
# ===========================================
# Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥å·¥å…· - å•ç‹¬è¿è¡ŒPlay 4
# åŠŸèƒ½: ä»…è¿è¡Œæœ¬åœ°æ±‡æ€»é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š
# ä½¿ç”¨: ansible-playbook -i inventory_unified.ini play4_only.yml -v
# ===========================================

# ===========================================
# Play 4: æœ¬åœ°æ±‡æ€»é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š (ç‹¬ç«‹ç‰ˆæœ¬)
# ===========================================
- name: "æœ¬åœ°æ±‡æ€»é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š (ç‹¬ç«‹è¿è¡Œ)"
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    local_results_dir: "./cluster_check_results"
    local_report_dir: "./report"
    
  tasks:
    - name: "åˆ›å»ºæœ¬åœ°ç»“æœç›®å½•"
      file:
        path: "{{ local_results_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p4_only_setup
        - local_create_results_dir
        - setup
        - report

    - name: "åˆ›å»ºæœ¬åœ°æŠ¥å‘Šç›®å½•"
      file:
        path: "{{ local_report_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p4_only_setup
        - local_create_report_dir
        - setup
        - report

    - name: "æ£€æŸ¥æ”¶é›†çš„æ£€æŸ¥ç»“æœ"
      find:
        paths: "{{ local_results_dir }}"
        patterns: "*.html"
      register: collected_reports
      tags:
        - p4_only_collect
        - local_find_collected_reports
        - collect
        - report

    - name: "æ˜¾ç¤ºæ”¶é›†åˆ°çš„æŠ¥å‘Šä¿¡æ¯"
      debug:
        msg: "æ”¶é›†åˆ° {{ collected_reports.files | length }} ä¸ªèŠ‚ç‚¹æ£€æŸ¥æŠ¥å‘Š"
      tags:
        - p4_only_collect
        - local_show_collected_count
        - collect
        - report

    - name: "åˆ†ç±»ç»Ÿè®¡æ”¶é›†çš„æŠ¥å‘Š"
      shell: |
        echo "=== æŠ¥å‘Šæ–‡ä»¶ç»Ÿè®¡ ==="
        echo "MasterèŠ‚ç‚¹æŠ¥å‘Š: $(ls {{ local_results_dir }}/*master*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "CPU WorkeræŠ¥å‘Š: $(ls {{ local_results_dir }}/*cpu_worker*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "GPU WorkeræŠ¥å‘Š: $(ls {{ local_results_dir }}/*gpu_worker*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la {{ local_results_dir }}/*.html 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°HTMLæŠ¥å‘Šæ–‡ä»¶"
      register: report_stats
      tags:
        - p4_only_collect
        - local_classify_reports
        - collect
        - report

    - name: "æ˜¾ç¤ºæŠ¥å‘Šç»Ÿè®¡ä¿¡æ¯"
      debug:
        msg: "{{ report_stats.stdout_lines }}"
      tags:
        - p4_only_collect
        - local_show_stats
        - collect
        - report

    - name: "å¤åˆ¶æŠ¥å‘Šåˆ°reportç›®å½•å¹¶é‡å‘½å"
      shell: |
        if [ -d "{{ local_results_dir }}" ] && [ "$(ls -A {{ local_results_dir }}/*.html 2>/dev/null)" ]; then
          echo "å¤åˆ¶æŠ¥å‘Šåˆ°reportç›®å½•..."
          for file in {{ local_results_dir }}/*.html; do
            if [[ -f "$file" ]]; then
              # æå–èŠ‚ç‚¹ç±»å‹å¹¶é‡å‘½å
              filename=$(basename "$file")
              if [[ $filename == *"master"* ]]; then
                new_name="MASTER_$(echo $filename | sed 's/.*_master_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              elif [[ $filename == *"cpu_worker"* ]]; then
                new_name="CPU_WORKER_$(echo $filename | sed 's/.*_cpu_worker_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              elif [[ $filename == *"gpu_worker"* ]]; then
                new_name="GPU_WORKER_$(echo $filename | sed 's/.*_gpu_worker_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              else
                new_name="$(basename $file)"
              fi
              cp "$file" "{{ local_report_dir }}/$new_name"
              echo "å¤åˆ¶: $filename -> $new_name"
            fi
          done
          echo "æŠ¥å‘Šå¤åˆ¶å®Œæˆ"
        else
          echo "è­¦å‘Š: æœªæ‰¾åˆ°æ£€æŸ¥ç»“æœæ–‡ä»¶"
        fi
      register: copy_reports_result
      tags:
        - p4_only_process
        - local_copy_rename_reports
        - process
        - report

    - name: "æ˜¾ç¤ºæŠ¥å‘Šå¤åˆ¶ç»“æœ"
      debug:
        msg: "{{ copy_reports_result.stdout_lines }}"
      tags:
        - p4_only_process
        - local_show_copy_result
        - process
        - report

    - name: "ç”Ÿæˆç»Ÿä¸€HTMLè¡¨æ ¼æŠ¥å‘Š"
      shell: |
        if [ -x "./generate_unified_report.sh" ]; then
          echo "ç”Ÿæˆç»Ÿä¸€æŠ¥å‘Š..."
          ./generate_unified_report.sh "{{ local_report_dir }}"
          if [ $? -eq 0 ]; then
            echo "âœ… ç»Ÿä¸€æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
          else
            echo "âš ï¸  ç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          fi
        else
          echo "âš ï¸  ç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨æˆ–æ— æ‰§è¡Œæƒé™"
        fi
      register: unified_report_result
      tags:
        - p4_only_generate
        - local_generate_unified_report
        - generate
        - report

    - name: "æ˜¾ç¤ºç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆç»“æœ"
      debug:
        msg: "{{ unified_report_result.stdout_lines }}"
      tags:
        - p4_only_generate
        - local_show_unified_result
        - generate
        - report

    - name: "æœ€ç»ˆæŠ¥å‘Šç»Ÿè®¡å’Œæ¸…ç†"
      shell: |
        echo "=== æœ€ç»ˆæŠ¥å‘Šç»Ÿè®¡ ==="
        if [ -d "{{ local_report_dir }}" ]; then
          echo "MasterèŠ‚ç‚¹æŠ¥å‘Š: $(ls {{ local_report_dir }}/MASTER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "CPU WorkeræŠ¥å‘Š: $(ls {{ local_report_dir }}/CPU_WORKER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "GPU WorkeræŠ¥å‘Š: $(ls {{ local_report_dir }}/GPU_WORKER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Š: $(ls {{ local_report_dir }}/unified_cluster_report.html 2>/dev/null | wc -l) ä¸ª"
        fi
        
        # å¯é€‰ï¼šæ¸…ç†ä¸´æ—¶çš„è¿œç¨‹è„šæœ¬æ–‡ä»¶ï¼ˆä¿ç•™æ£€æŸ¥ç»“æœï¼‰
        echo "ä¿ç•™è¯¦ç»†æŠ¥å‘Šï¼Œä»…æ˜¾ç¤ºæ±‡æ€»æŠ¥å‘Šä½ç½®"
        if [ -f "{{ local_report_dir }}/unified_cluster_report.html" ]; then
          echo "âœ… ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: {{ local_report_dir }}/unified_cluster_report.html"
        else
          echo "âš ï¸  ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
        fi
      register: final_stats
      tags:
        - p4_only_finalize
        - local_final_stats
        - finalize
        - report

    - name: "æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡ç»“æœ"
      debug:
        msg: "{{ final_stats.stdout_lines }}"
      tags:
        - p4_only_finalize
        - local_show_final_stats
        - finalize
        - report

    - name: "æŠ¥å‘Šå®Œæˆä¿¡æ¯"
      debug:
        msg:
          - "ğŸ‰ é›†ç¾¤å¥åº·æ£€æŸ¥æŠ¥å‘Šæ±‡æ€»å®Œæˆ!"
          - "ğŸ“Š è¯¦ç»†æŠ¥å‘Šä½ç½®: {{ local_report_dir }}/"
          - "ğŸ“‹ ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Š: {{ local_report_dir }}/unified_cluster_report.html"
          - "ğŸ’¡ å»ºè®®: ä¸»è¦æŸ¥çœ‹ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šï¼Œéœ€è¦è¯¦ç»†ä¿¡æ¯æ—¶æŸ¥çœ‹å•ä¸ªèŠ‚ç‚¹æŠ¥å‘Š"
      tags:
        - p4_only_finalize
        - local_completion_info
        - finalize
        - report
