---
# ===========================================
# Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥å·¥å…· - ç»Ÿä¸€Playbook v2.0
# åŠŸèƒ½: MasterèŠ‚ç‚¹ + CPU WorkerèŠ‚ç‚¹ + GPU WorkerèŠ‚ç‚¹ (å«DCGMç›‘æ§)
# ç‰¹ç‚¹: copyæœ¬åœ°æ¨¡æ¿ -> è¿œç¨‹æ‰§è¡Œ -> ç»“æœå›ä¼  -> æœ¬åœ°æ±‡æ€»
# ===========================================

# ===========================================
# Play 1: MasterèŠ‚ç‚¹æ£€æŸ¥
# ===========================================
- name: "ç»Ÿä¸€Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥ - MasterèŠ‚ç‚¹"
  hosts: k8s_masters:k8s_masters_demo
  gather_facts: yes
  serial: 3
  vars:
    check_script_path: "{{ remote_script_path }}"
    results_dir: "{{ remote_results_dir }}"
    template_path: "{{ remote_template_path }}"
    
  tasks:
    - name: "åœ¨MasterèŠ‚ç‚¹åˆ›å»ºç»“æœç›®å½•"
      file:
        path: "{{ results_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p1_master_setup
        - master_create_dir
        - setup

    - name: "å¤åˆ¶MasterèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¨¡æ¿åˆ°è¿œç¨‹"
      copy:
        src: "./templates/master_check_script.sh.j2"
        dest: "{{ template_path }}"
        mode: '0644'
      tags:
        - p1_master_setup
        - master_copy_template
        - setup

    - name: "åœ¨è¿œç¨‹èŠ‚ç‚¹å¤„ç†æ¨¡æ¿å¹¶ç”Ÿæˆæ£€æŸ¥è„šæœ¬"
      shell: |
        # æ›¿æ¢Jinja2æ¨¡æ¿å˜é‡
        sed "s/{{ ansible_hostname }}/{{ ansible_hostname }}/g; \
             s|{{ results_dir }}|{{ results_dir }}|g; \
             s/{{ node_name | default(ansible_hostname) }}/{{ node_name | default(ansible_hostname) }}/g" \
        "{{ template_path }}" > "{{ check_script_path }}"
        chmod +x "{{ check_script_path }}"
        # æ¸…ç†æ¨¡æ¿æ–‡ä»¶
        rm -f "{{ template_path }}"
      tags:
        - p1_master_setup
        - master_process_template
        - setup

    - name: "æ‰§è¡ŒMasterèŠ‚ç‚¹å¥åº·æ£€æŸ¥å¹¶ç”ŸæˆæŠ¥å‘Š"
      shell: |
        export OUTPUT_FORMAT="{{ output_format | default('html') }}"
        export SIMPLIFIED_REPORT="{{ simplified_report | default('false') }}"
        export NODE_TYPE=master
        export NODE_NAME="{{ node_name | default(ansible_hostname) }}"
        "{{ check_script_path }}"
      register: master_check_result
      ignore_errors: yes
      tags:
        - p1_master_check
        - master_execute_check
        - check

    - name: "æ˜¾ç¤ºMasterèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      debug:
        msg: "{{ master_check_result.stdout_lines }}"
      when: master_check_result.stdout_lines is defined
      tags:
        - p1_master_check
        - master_show_result
        - check

    - name: "æŸ¥æ‰¾ç”Ÿæˆçš„MasterèŠ‚ç‚¹æŠ¥å‘Šæ–‡ä»¶"
      find:
        paths: "{{ results_dir }}"
        patterns: 
          - "*master*check*.html"
          - "*master*check*.txt"
        age: "-1h"
      register: master_report_files
      tags:
        - p1_master_fetch
        - master_find_reports
        - fetch

    - name: "è·å–MasterèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_results_dir }}/{{ inventory_hostname }}_{{ item.path | basename }}"
        flat: yes
      with_items: "{{ master_report_files.files }}"
      when: master_report_files.files | length > 0
      ignore_errors: yes
      tags:
        - p1_master_fetch
        - master_fetch_results
        - fetch

    - name: "æ¸…ç†MasterèŠ‚ç‚¹çš„ä¸´æ—¶æ–‡ä»¶"
      shell: |
        # æ¸…ç†è¿œç¨‹ç”Ÿæˆçš„HTMLæŠ¥å‘Šæ–‡ä»¶
        if [ -d "{{ results_dir }}" ]; then
          echo "æ¸…ç†è¿œç¨‹ä¸´æ—¶HTMLæ–‡ä»¶..."
          rm -f {{ results_dir }}/*master*check*.html
          echo "MasterèŠ‚ç‚¹HTMLæ–‡ä»¶æ¸…ç†å®Œæˆ"
        fi
        
        # æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬
        if [ -f "{{ check_script_path }}" ]; then
          echo "æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬..."
          rm -f "{{ check_script_path }}"
          echo "MasterèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¸…ç†å®Œæˆ"
        fi
        
        echo "MasterèŠ‚ç‚¹ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
      when: cleanup_temp_files | default(true) | bool
      ignore_errors: yes
      tags:
        - p1_master_cleanup
        - master_cleanup_temp_files
        - cleanup

# ===========================================
# Play 2: CPU WorkerèŠ‚ç‚¹æ£€æŸ¥
# ===========================================
- name: "ç»Ÿä¸€Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥ - CPU WorkerèŠ‚ç‚¹"
  hosts: k8s_cpu_workers:k8s_cpu_workers_demo
  gather_facts: yes
  serial: 5
  vars:
    check_script_path: "{{ remote_script_path }}"
    results_dir: "{{ remote_results_dir }}"
    template_path: "{{ remote_template_path }}"
    
  tasks:
    - name: "åœ¨CPU WorkerèŠ‚ç‚¹åˆ›å»ºç»“æœç›®å½•"
      file:
        path: "{{ results_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p2_cpu_worker_setup
        - cpu_worker_create_dir
        - setup

    - name: "å¤åˆ¶CPU WorkerèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¨¡æ¿åˆ°è¿œç¨‹"
      copy:
        src: "./templates/cpu_worker_check_script.sh.j2"
        dest: "{{ template_path }}"
        mode: '0644'
      tags:
        - p2_cpu_worker_setup
        - cpu_worker_copy_template
        - setup

    - name: "åœ¨è¿œç¨‹èŠ‚ç‚¹å¤„ç†æ¨¡æ¿å¹¶ç”Ÿæˆæ£€æŸ¥è„šæœ¬"
      shell: |
        # æ›¿æ¢Jinja2æ¨¡æ¿å˜é‡
        sed "s/{{ ansible_hostname }}/{{ ansible_hostname }}/g; \
             s|{{ results_dir }}|{{ results_dir }}|g; \
             s/{{ node_name | default(ansible_hostname) }}/{{ node_name | default(ansible_hostname) }}/g" \
        "{{ template_path }}" > "{{ check_script_path }}"
        chmod +x "{{ check_script_path }}"
        # æ¸…ç†æ¨¡æ¿æ–‡ä»¶
        rm -f "{{ template_path }}"
      tags:
        - p2_cpu_worker_setup
        - cpu_worker_process_template
        - setup

    - name: "æ‰§è¡ŒCPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥å¹¶ç”ŸæˆæŠ¥å‘Š"
      shell: |
        export OUTPUT_FORMAT="{{ output_format | default('html') }}"
        export SIMPLIFIED_REPORT="{{ simplified_report | default('false') }}"
        export NODE_TYPE=cpu_worker
        export NODE_NAME="{{ node_name | default(ansible_hostname) }}"
        "{{ check_script_path }}"
      register: cpu_worker_check_result
      ignore_errors: yes
      tags:
        - p2_cpu_worker_check
        - cpu_worker_execute_check
        - check

    - name: "æ˜¾ç¤ºCPU WorkerèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      debug:
        msg: "{{ cpu_worker_check_result.stdout_lines }}"
      when: cpu_worker_check_result.stdout_lines is defined
      tags:
        - p2_cpu_worker_check
        - cpu_worker_show_result
        - check

    - name: "æŸ¥æ‰¾ç”Ÿæˆçš„CPU WorkerèŠ‚ç‚¹æŠ¥å‘Šæ–‡ä»¶"
      find:
        paths: "{{ results_dir }}"
        patterns: 
          - "*cpu_worker*check*.html"
          - "*cpu_worker*check*.txt"
        age: "-1h"
      register: cpu_worker_report_files
      tags:
        - p2_cpu_worker_fetch
        - cpu_worker_find_reports
        - fetch

    - name: "è·å–CPU WorkerèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_results_dir }}/{{ inventory_hostname }}_{{ item.path | basename }}"
        flat: yes
      with_items: "{{ cpu_worker_report_files.files }}"
      when: cpu_worker_report_files.files | length > 0
      ignore_errors: yes
      tags:
        - p2_cpu_worker_fetch
        - cpu_worker_fetch_results
        - fetch

    - name: "æ¸…ç†CPU WorkerèŠ‚ç‚¹çš„ä¸´æ—¶æ–‡ä»¶"
      shell: |
        # æ¸…ç†è¿œç¨‹ç”Ÿæˆçš„HTMLæŠ¥å‘Šæ–‡ä»¶
        if [ -d "{{ results_dir }}" ]; then
          echo "æ¸…ç†è¿œç¨‹ä¸´æ—¶HTMLæ–‡ä»¶..."
          rm -f {{ results_dir }}/*cpu_worker*check*.html
          echo "CPU WorkerèŠ‚ç‚¹HTMLæ–‡ä»¶æ¸…ç†å®Œæˆ"
        fi
        
        # æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬
        if [ -f "{{ check_script_path }}" ]; then
          echo "æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬..."
          rm -f "{{ check_script_path }}"
          echo "CPU WorkerèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¸…ç†å®Œæˆ"
        fi
        
        echo "CPU WorkerèŠ‚ç‚¹ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
      when: cleanup_temp_files | default(true) | bool
      ignore_errors: yes
      tags:
        - p2_cpu_worker_cleanup
        - cpu_worker_cleanup_temp_files
        - cleanup

# ===========================================
# Play 3: GPU WorkerèŠ‚ç‚¹æ£€æŸ¥ (å«DCGMç›‘æ§)
# ===========================================
- name: "ç»Ÿä¸€Kubernetesé›†ç¾¤å¥åº·æ£€æŸ¥ - GPU WorkerèŠ‚ç‚¹"
  hosts: k8s_gpu_workers:k8s_gpu_workers_demo
  gather_facts: yes
  serial: 3
  vars:
    check_script_path: "{{ remote_script_path }}"
    results_dir: "{{ remote_results_dir }}"
    template_path: "{{ remote_template_path }}"
    
  tasks:
    - name: "åœ¨GPU WorkerèŠ‚ç‚¹åˆ›å»ºç»“æœç›®å½•"
      file:
        path: "{{ results_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p3_gpu_worker_setup
        - gpu_worker_create_dir
        - setup

    - name: "å¤åˆ¶GPU WorkerèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¨¡æ¿åˆ°è¿œç¨‹"
      copy:
        src: "./templates/gpu_worker_check_script.sh.j2"
        dest: "{{ template_path }}"
        mode: '0644'
      tags:
        - p3_gpu_worker_setup
        - gpu_worker_copy_template
        - setup

    - name: "åœ¨è¿œç¨‹èŠ‚ç‚¹å¤„ç†æ¨¡æ¿å¹¶ç”Ÿæˆæ£€æŸ¥è„šæœ¬"
      shell: |
        # æ›¿æ¢Jinja2æ¨¡æ¿å˜é‡
        sed "s/{{ ansible_hostname }}/{{ ansible_hostname }}/g; \
             s|{{ results_dir }}|{{ results_dir }}|g; \
             s/{{ node_name | default(ansible_hostname) }}/{{ node_name | default(ansible_hostname) }}/g; \
             s/{{ gpu_type | default('unknown') }}/{{ gpu_type | default('unknown') }}/g" \
        "{{ template_path }}" > "{{ check_script_path }}"
        chmod +x "{{ check_script_path }}"
        # æ¸…ç†æ¨¡æ¿æ–‡ä»¶
        rm -f "{{ template_path }}"
      tags:
        - p3_gpu_worker_setup
        - gpu_worker_process_template
        - setup

    - name: "æ‰§è¡ŒGPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥å¹¶ç”ŸæˆæŠ¥å‘Š (å«DCGMç›‘æ§)"
      shell: |
        export OUTPUT_FORMAT="{{ output_format | default('html') }}"
        export SIMPLIFIED_REPORT="{{ simplified_report | default('false') }}"
        export NODE_TYPE=gpu_worker
        export NODE_NAME="{{ node_name | default(ansible_hostname) }}"
        export GPU_TYPE="{{ gpu_type | default('unknown') }}"
        "{{ check_script_path }}"
      register: gpu_worker_check_result
      ignore_errors: yes
      tags:
        - p3_gpu_worker_check
        - gpu_worker_execute_check
        - check

    - name: "æ˜¾ç¤ºGPU WorkerèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      debug:
        msg: "{{ gpu_worker_check_result.stdout_lines }}"
      when: gpu_worker_check_result.stdout_lines is defined
      tags:
        - p3_gpu_worker_check
        - gpu_worker_show_result
        - check

    - name: "æŸ¥æ‰¾ç”Ÿæˆçš„GPU WorkerèŠ‚ç‚¹æŠ¥å‘Šæ–‡ä»¶"
      find:
        paths: "{{ results_dir }}"
        patterns: 
          - "*gpu_worker*check*.html"
          - "*gpu_worker*check*.txt"
        age: "-1h"
      register: gpu_worker_report_files
      tags:
        - p3_gpu_worker_fetch
        - gpu_worker_find_reports
        - fetch

    - name: "è·å–GPU WorkerèŠ‚ç‚¹æ£€æŸ¥ç»“æœ"
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_results_dir }}/{{ inventory_hostname }}_{{ item.path | basename }}"
        flat: yes
      with_items: "{{ gpu_worker_report_files.files }}"
      when: gpu_worker_report_files.files | length > 0
      ignore_errors: yes
      tags:
        - p3_gpu_worker_fetch
        - gpu_worker_fetch_results
        - fetch

    - name: "æ¸…ç†GPU WorkerèŠ‚ç‚¹çš„ä¸´æ—¶æ–‡ä»¶"
      shell: |
        # æ¸…ç†è¿œç¨‹ç”Ÿæˆçš„HTMLæŠ¥å‘Šæ–‡ä»¶
        if [ -d "{{ results_dir }}" ]; then
          echo "æ¸…ç†è¿œç¨‹ä¸´æ—¶HTMLæ–‡ä»¶..."
          rm -f {{ results_dir }}/*gpu_worker*check*.html
          echo "GPU WorkerèŠ‚ç‚¹HTMLæ–‡ä»¶æ¸…ç†å®Œæˆ"
        fi
        
        # æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬
        if [ -f "{{ check_script_path }}" ]; then
          echo "æ¸…ç†è¿œç¨‹æ£€æŸ¥è„šæœ¬..."
          rm -f "{{ check_script_path }}"
          echo "GPU WorkerèŠ‚ç‚¹æ£€æŸ¥è„šæœ¬æ¸…ç†å®Œæˆ"
        fi
        
        echo "GPU WorkerèŠ‚ç‚¹ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
      when: cleanup_temp_files | default(true) | bool
      ignore_errors: yes
      tags:
        - p3_gpu_worker_cleanup
        - gpu_worker_cleanup_temp_files
        - cleanup

# ===========================================
# Play 4: æœ¬åœ°æ±‡æ€»é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š
# ===========================================
- name: "æœ¬åœ°æ±‡æ€»é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š"
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    local_results_dir: "./cluster_check_results"
    local_report_dir: "./report"
    
  tasks:
    - name: "åˆ›å»ºæœ¬åœ°ç»“æœç›®å½•"
      file:
        path: "{{ local_results_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p4_local_setup
        - local_create_results_dir
        - setup
        - report

    - name: "åˆ›å»ºæœ¬åœ°æŠ¥å‘Šç›®å½•"
      file:
        path: "{{ local_report_dir }}"
        state: directory
        mode: '0755'
      tags:
        - p4_local_setup
        - local_create_report_dir
        - setup
        - report

    - name: "æ£€æŸ¥æ”¶é›†çš„æ£€æŸ¥ç»“æœ"
      find:
        paths: "{{ local_results_dir }}"
        patterns: "*.html"
      register: collected_reports
      tags:
        - p4_collect_reports
        - local_find_collected_reports
        - collect
        - report

    - name: "æ˜¾ç¤ºæ”¶é›†åˆ°çš„æŠ¥å‘Šä¿¡æ¯"
      debug:
        msg: "æ”¶é›†åˆ° {{ collected_reports.files | length }} ä¸ªèŠ‚ç‚¹æ£€æŸ¥æŠ¥å‘Š"
      tags:
        - p4_collect_reports
        - local_show_collected_count
        - collect
        - report

    - name: "åˆ†ç±»ç»Ÿè®¡æ”¶é›†çš„æŠ¥å‘Š"
      shell: |
        echo "=== æŠ¥å‘Šæ–‡ä»¶ç»Ÿè®¡ ==="
        echo "MasterèŠ‚ç‚¹æŠ¥å‘Š: $(ls {{ local_results_dir }}/*master*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "CPU WorkeræŠ¥å‘Š: $(ls {{ local_results_dir }}/*cpu_worker*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "GPU WorkeræŠ¥å‘Š: $(ls {{ local_results_dir }}/*gpu_worker*check*.html 2>/dev/null | wc -l) ä¸ª"
        echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la {{ local_results_dir }}/*.html 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°HTMLæŠ¥å‘Šæ–‡ä»¶"
      register: report_stats
      tags:
        - p4_collect_reports
        - local_classify_reports
        - collect
        - report

    - name: "æ˜¾ç¤ºæŠ¥å‘Šç»Ÿè®¡ä¿¡æ¯"
      debug:
        msg: "{{ report_stats.stdout_lines }}"
      tags:
        - p4_collect_reports
        - local_show_stats
        - collect
        - report

    - name: "å¤åˆ¶æŠ¥å‘Šåˆ°reportç›®å½•å¹¶é‡å‘½å"
      shell: |
        if [ -d "{{ local_results_dir }}" ] && [ "$(ls -A {{ local_results_dir }}/*.html 2>/dev/null)" ]; then
          echo "å¤åˆ¶æŠ¥å‘Šåˆ°reportç›®å½•..."
          for file in {{ local_results_dir }}/*.html; do
            if [[ -f "$file" ]]; then
              # æå–èŠ‚ç‚¹ç±»å‹å¹¶é‡å‘½å
              filename=$(basename "$file")
              if [[ $filename == *"master"* ]]; then
                new_name="MASTER_$(echo $filename | sed 's/.*_master_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              elif [[ $filename == *"cpu_worker"* ]]; then
                new_name="CPU_WORKER_$(echo $filename | sed 's/.*_cpu_worker_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              elif [[ $filename == *"gpu_worker"* ]]; then
                new_name="GPU_WORKER_$(echo $filename | sed 's/.*_gpu_worker_check_//' | sed 's/.html$//')_$(date +%Y%m%d_%H%M%S).html"
              else
                new_name="$(basename $file)"
              fi
              cp "$file" "{{ local_report_dir }}/$new_name"
              echo "å¤åˆ¶: $filename -> $new_name"
            fi
          done
          echo "æŠ¥å‘Šå¤åˆ¶å®Œæˆ"
        else
          echo "è­¦å‘Š: æœªæ‰¾åˆ°æ£€æŸ¥ç»“æœæ–‡ä»¶"
        fi
      register: copy_reports_result
      tags:
        - p4_process_reports
        - local_copy_rename_reports
        - process
        - report

    - name: "æ˜¾ç¤ºæŠ¥å‘Šå¤åˆ¶ç»“æœ"
      debug:
        msg: "{{ copy_reports_result.stdout_lines }}"
      tags:
        - p4_process_reports
        - local_show_copy_result
        - process
        - report

    - name: "ç”Ÿæˆç»Ÿä¸€HTMLè¡¨æ ¼æŠ¥å‘Š"
      shell: |
        if [ -x "./generate_unified_report.sh" ]; then
          echo "ç”Ÿæˆç»Ÿä¸€æŠ¥å‘Š..."
          ./generate_unified_report.sh "{{ local_report_dir }}"
          if [ $? -eq 0 ]; then
            echo "âœ… ç»Ÿä¸€æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
          else
            echo "âš ï¸  ç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          fi
        else
          echo "âš ï¸  ç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨æˆ–æ— æ‰§è¡Œæƒé™"
        fi
      register: unified_report_result
      tags:
        - p4_generate_unified
        - local_generate_unified_report
        - generate
        - report

    - name: "ç”Ÿæˆç®€åŒ–MarkdownæŠ¥å‘Š"
      shell: |
        if [ "{{ generate_markdown | default('false') }}" = "true" ]; then
          if [ -x "./generate_simplified_markdown_report.sh" ]; then
            echo "ç”Ÿæˆç®€åŒ–MarkdownæŠ¥å‘Š..."
            ./generate_simplified_markdown_report.sh "{{ local_results_dir }}"
            if [ $? -eq 0 ]; then
              echo "âœ… ç®€åŒ–MarkdownæŠ¥å‘Šç”ŸæˆæˆåŠŸ"
            else
              echo "âš ï¸  ç®€åŒ–MarkdownæŠ¥å‘Šç”Ÿæˆå¤±è´¥"
            fi
          else
            echo "âš ï¸  ç®€åŒ–MarkdownæŠ¥å‘Šç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨æˆ–æ— æ‰§è¡Œæƒé™"
          fi
        else
          echo "è·³è¿‡MarkdownæŠ¥å‘Šç”Ÿæˆ (generate_markdown={{ generate_markdown | default('false') }})"
        fi
      register: markdown_report_result
      tags:
        - p4_generate_markdown
        - local_generate_markdown_report
        - generate
        - report

    - name: "æ˜¾ç¤ºç»Ÿä¸€æŠ¥å‘Šç”Ÿæˆç»“æœ"
      debug:
        msg: "{{ unified_report_result.stdout_lines }}"
      tags:
        - p4_generate_unified
        - local_show_unified_result
        - generate
        - report

    - name: "æœ€ç»ˆæŠ¥å‘Šç»Ÿè®¡å’Œæ¸…ç†"
      shell: |
        echo "=== æœ€ç»ˆæŠ¥å‘Šç»Ÿè®¡ ==="
        if [ -d "{{ local_report_dir }}" ]; then
          echo "MasterèŠ‚ç‚¹æŠ¥å‘Š: $(ls {{ local_report_dir }}/MASTER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "CPU WorkeræŠ¥å‘Š: $(ls {{ local_report_dir }}/CPU_WORKER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "GPU WorkeræŠ¥å‘Š: $(ls {{ local_report_dir }}/GPU_WORKER_*.html 2>/dev/null | wc -l) ä¸ª"
          echo "ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Š: $(ls {{ local_report_dir }}/unified_cluster_report.html 2>/dev/null | wc -l) ä¸ª"
        fi
        
        # å¯é€‰ï¼šæ¸…ç†ä¸´æ—¶çš„è¿œç¨‹è„šæœ¬æ–‡ä»¶ï¼ˆä¿ç•™æ£€æŸ¥ç»“æœï¼‰
        echo "ä¿ç•™è¯¦ç»†æŠ¥å‘Šï¼Œä»…æ˜¾ç¤ºæ±‡æ€»æŠ¥å‘Šä½ç½®"
        if [ -f "{{ local_report_dir }}/unified_cluster_report.html" ]; then
          echo "âœ… ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: {{ local_report_dir }}/unified_cluster_report.html"
        else
          echo "âš ï¸  ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
        fi
      register: final_stats
      tags:
        - p4_finalize
        - local_final_stats
        - finalize
        - report

    - name: "æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡ç»“æœ"
      debug:
        msg: "{{ final_stats.stdout_lines }}"
      tags:
        - p4_finalize
        - local_show_final_stats
        - finalize
        - report

    - name: "æŠ¥å‘Šå®Œæˆä¿¡æ¯"
      debug:
        msg:
          - "ğŸ‰ é›†ç¾¤å¥åº·æ£€æŸ¥å®Œæˆ!"
          - "ğŸ“Š è¯¦ç»†æŠ¥å‘Šä½ç½®: {{ local_report_dir }}/"
          - "ğŸ“‹ ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Š: {{ local_report_dir }}/unified_cluster_report.html"
          - "ğŸ’¡ å»ºè®®: ä¸»è¦æŸ¥çœ‹ç»Ÿä¸€æ±‡æ€»æŠ¥å‘Šï¼Œéœ€è¦è¯¦ç»†ä¿¡æ¯æ—¶æŸ¥çœ‹å•ä¸ªèŠ‚ç‚¹æŠ¥å‘Š"
      tags:
        - p4_finalize
        - local_completion_info
        - finalize
        - report
