#!/bin/bash
# CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥è„šæœ¬

OUTPUT_FORMAT="${OUTPUT_FORMAT:-html}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
HOSTNAME=$(hostname)
RESULTS_DIR="/tmp/cluster_check_results"
NODE_TYPE="${NODE_TYPE:-cpu_worker}"

mkdir -p "$RESULTS_DIR"

if [ "$OUTPUT_FORMAT" = "html" ]; then
    REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_${TIMESTAMP}.html"
else
    REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_${TIMESTAMP}.txt"
fi

echo "ğŸ”§ åœ¨$HOSTNAMEä¸Šå¼€å§‹CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥"
echo "ğŸ“… æ—¶é—´æˆ³: $(date)"
echo "ğŸ“‚ æŠ¥å‘Šå°†ä¿å­˜åˆ°: $REPORT_FILE"

# ç”ŸæˆHTMLæŠ¥å‘Š
if [ "$OUTPUT_FORMAT" = "html" ]; then
    cat > "$REPORT_FILE" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥æŠ¥å‘Š</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #ff7b7b 0%, #667eea 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1em; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section h2 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #ff7b7b; }
        .info-card h3 { margin: 0 0 10px 0; color: #495057; }
        .status { padding: 4px 12px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .command-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; overflow-x: auto; }
        .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; border-top: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥</h1>
            <p>èŠ‚ç‚¹: $(hostname) | æ—¶é—´: $(date)</p>
        </div>
        <div class="content">
EOF

    # ç³»ç»Ÿä¿¡æ¯
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>' >> "$REPORT_FILE"
    echo '<div class="info-grid">' >> "$REPORT_FILE"
    
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ–¥ï¸ åŸºæœ¬ç³»ç»Ÿä¿¡æ¯</h3>' >> "$REPORT_FILE"
    echo "<p><strong>ä¸»æœºå:</strong> $(hostname)</p>" >> "$REPORT_FILE"
    echo "<p><strong>æ“ä½œç³»ç»Ÿ:</strong> $(lsb_release -d 2>/dev/null | cut -f2 || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)</p>" >> "$REPORT_FILE"
    echo "<p><strong>å†…æ ¸ç‰ˆæœ¬:</strong> $(uname -r)</p>" >> "$REPORT_FILE"
    echo "<p><strong>ç³»ç»Ÿæ¶æ„:</strong> $(uname -m)</p>" >> "$REPORT_FILE"
    echo "<p><strong>ç³»ç»Ÿè¿è¡Œæ—¶é—´:</strong> $(uptime -p 2>/dev/null || uptime)</p>" >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ’¾ å†…å­˜å’ŒCPU</h3>' >> "$REPORT_FILE"
    echo "<p><strong>CPUæ ¸å¿ƒæ•°:</strong> $(nproc)</p>" >> "$REPORT_FILE"
    echo "<p><strong>CPUå‹å·:</strong> $(grep -m1 'model name' /proc/cpuinfo | cut -d':' -f2 | xargs)</p>" >> "$REPORT_FILE"
    echo "<p><strong>æ€»å†…å­˜:</strong> $(free -h | awk '/^Mem:/ {print $2}')</p>" >> "$REPORT_FILE"
    echo "<p><strong>å¯ç”¨å†…å­˜:</strong> $(free -h | awk '/^Mem:/ {print $7}')</p>" >> "$REPORT_FILE"
    echo "<p><strong>è´Ÿè½½å¹³å‡å€¼:</strong> $(uptime | awk -F'load average:' '{print $2}')</p>" >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # Kubernetes WorkerèŠ‚ç‚¹ç³»ç»Ÿé…ç½®æ£€æŸ¥
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>ğŸ”§ Kubernetes WorkerèŠ‚ç‚¹ç³»ç»Ÿé…ç½®æ£€æŸ¥</h2>' >> "$REPORT_FILE"
    
    # Cgroupç‰ˆæœ¬æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ“ Cgroupç‰ˆæœ¬æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    if [ -d /sys/fs/cgroup/unified ]; then
        echo '<p><strong>Cgroupç‰ˆæœ¬:</strong> <span class="status success">Cgroup v2</span></p>' >> "$REPORT_FILE"
    elif [ -d /sys/fs/cgroup/memory ]; then
        echo '<p><strong>Cgroupç‰ˆæœ¬:</strong> <span class="status warning">Cgroup v1</span></p>' >> "$REPORT_FILE"
        echo '<p>å»ºè®®ï¼šç°ä»£Kubernetesç‰ˆæœ¬æ¨èä½¿ç”¨Cgroup v2</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Cgroupç‰ˆæœ¬:</strong> <span class="status error">æœªçŸ¥</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # é˜²ç«å¢™çŠ¶æ€æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ”¥ é˜²ç«å¢™çŠ¶æ€æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    if systemctl is-active --quiet firewalld; then
        echo '<p><strong>Firewalld:</strong> <span class="status error">è¿è¡Œä¸­ âŒ</span></p>' >> "$REPORT_FILE"
        echo '<p>â— è­¦å‘Šï¼šé˜²ç«å¢™åº”è¯¥å…³é—­ä»¥é¿å…Kubernetesç½‘ç»œé—®é¢˜</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Firewalld:</strong> <span class="status success">å·²å…³é—­ âœ…</span></p>' >> "$REPORT_FILE"
    fi
    
    if systemctl is-active --quiet ufw; then
        echo '<p><strong>UFW:</strong> <span class="status error">è¿è¡Œä¸­ âŒ</span></p>' >> "$REPORT_FILE"
        echo '<p>â— è­¦å‘Šï¼šUFWé˜²ç«å¢™åº”è¯¥å…³é—­</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>UFW:</strong> <span class="status success">å·²å…³é—­ âœ…</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # SELinuxçŠ¶æ€æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ”’ SELinuxçŠ¶æ€æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    if command -v getenforce >/dev/null 2>&1; then
        selinux_status=$(getenforce 2>/dev/null)
        if [ "$selinux_status" = "Disabled" ]; then
            echo '<p><strong>SELinux:</strong> <span class="status success">å·²ç¦ç”¨ âœ…</span></p>' >> "$REPORT_FILE"
        else
            echo "<p><strong>SELinux:</strong> <span class=\"status error\">$selinux_status âŒ</span></p>" >> "$REPORT_FILE"
            echo '<p>â— è­¦å‘Šï¼šSELinuxåº”è¯¥ç¦ç”¨ä»¥é¿å…Kubernetesæƒé™é—®é¢˜</p>' >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>SELinux:</strong> <span class="status success">æœªå®‰è£… âœ…</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # Swapæ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ’½ SwapçŠ¶æ€æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    swap_info=$(swapon --show 2>/dev/null)
    if [ -z "$swap_info" ]; then
        echo '<p><strong>Swap:</strong> <span class="status success">å·²ç¦ç”¨ âœ…</span></p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Swap:</strong> <span class="status error">å¯ç”¨ä¸­ âŒ</span></p>' >> "$REPORT_FILE"
        echo '<p>â— è­¦å‘Šï¼šKubernetesè¦æ±‚ç¦ç”¨Swap</p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "$swap_info" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # æ—¶åŒºå’ŒNTPæ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ• æ—¶åŒºå’Œæ—¶é—´åŒæ­¥æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    current_timezone=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "unknown")
    if [ "$current_timezone" = "Asia/Shanghai" ]; then
        echo '<p><strong>æ—¶åŒº:</strong> <span class="status success">Asia/Shanghai âœ…</span></p>' >> "$REPORT_FILE"
    else
        echo "<p><strong>æ—¶åŒº:</strong> <span class=\"status error\">$current_timezone âŒ</span></p>" >> "$REPORT_FILE"
        echo '<p>â— è­¦å‘Šï¼šå»ºè®®è®¾ç½®æ—¶åŒºä¸ºAsia/Shanghai</p>' >> "$REPORT_FILE"
    fi
    
    if systemctl is-active --quiet chronyd; then
        echo '<p><strong>Chronyd:</strong> <span class="status success">è¿è¡Œä¸­ âœ…</span></p>' >> "$REPORT_FILE"
    elif systemctl is-active --quiet ntp; then
        echo '<p><strong>NTP:</strong> <span class="status success">è¿è¡Œä¸­ âœ…</span></p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>æ—¶é—´åŒæ­¥:</strong> <span class="status error">æœªé…ç½® âŒ</span></p>' >> "$REPORT_FILE"
        echo '<p>â— è­¦å‘Šï¼šå»ºè®®é…ç½®Chronydæˆ–NTPè¿›è¡Œæ—¶é—´åŒæ­¥</p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # å†…æ ¸å‚æ•°æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>âš™ï¸ Kuberneteså†…æ ¸å‚æ•°æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    echo '<p>æ£€æŸ¥ /etc/sysctl.d/k8s.conf ä¸­çš„å…³é”®å‚æ•°:</p>' >> "$REPORT_FILE"
    
    # æ£€æŸ¥å…³é”®å†…æ ¸å‚æ•°
    check_sysctl_param() {
        local param=$1
        local expected=$2
        local current=$(sysctl -n $param 2>/dev/null)
        if [ "$current" = "$expected" ]; then
            echo "<p><strong>$param:</strong> <span class=\"status success\">$current âœ…</span></p>" >> "$REPORT_FILE"
        else
            echo "<p><strong>$param:</strong> <span class=\"status error\">$current (æœŸæœ›: $expected) âŒ</span></p>" >> "$REPORT_FILE"
        fi
    }
    
    check_sysctl_param "net.bridge.bridge-nf-call-ip6tables" "1"
    check_sysctl_param "net.bridge.bridge-nf-call-iptables" "1"
    check_sysctl_param "net.ipv4.ip_forward" "1"
    check_sysctl_param "vm.swappiness" "0"
    check_sysctl_param "net.ipv4.conf.default.rp_filter" "1"
    check_sysctl_param "net.ipv4.conf.all.rp_filter" "1"
    
    if [ -f /etc/sysctl.d/k8s.conf ]; then
        echo '<p><strong>é…ç½®æ–‡ä»¶:</strong> <span class="status success">/etc/sysctl.d/k8s.conf å­˜åœ¨ âœ…</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== /etc/sysctl.d/k8s.conf å†…å®¹ ===" >> "$REPORT_FILE"
        cat /etc/sysctl.d/k8s.conf >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>é…ç½®æ–‡ä»¶:</strong> <span class="status error">/etc/sysctl.d/k8s.conf ä¸å­˜åœ¨ âŒ</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # Kubernetesè½¯ä»¶åŒ…æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ“¦ Kubernetesè½¯ä»¶åŒ…æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    
    # æ£€æŸ¥kubelet
    if command -v kubelet >/dev/null 2>&1; then
        kubelet_version=$(kubelet --version 2>/dev/null | awk '{print $2}')
        echo "<p><strong>kubelet:</strong> <span class=\"status success\">$kubelet_version âœ…</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubelet:</strong> <span class="status error">æœªå®‰è£… âŒ</span></p>' >> "$REPORT_FILE"
    fi
    
    # æ£€æŸ¥kubeadm
    if command -v kubeadm >/dev/null 2>&1; then
        kubeadm_version=$(kubeadm version -o short 2>/dev/null)
        echo "<p><strong>kubeadm:</strong> <span class=\"status success\">$kubeadm_version âœ…</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubeadm:</strong> <span class="status error">æœªå®‰è£… âŒ</span></p>' >> "$REPORT_FILE"
    fi
    
    # æ£€æŸ¥kubectl
    if command -v kubectl >/dev/null 2>&1; then
        kubectl_version=$(kubectl version --client -o json 2>/dev/null | grep gitVersion | cut -d'"' -f4)
        echo "<p><strong>kubectl:</strong> <span class=\"status success\">$kubectl_version âœ…</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubectl:</strong> <span class="status warning">æœªå®‰è£… âš ï¸</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    
    # å®¹å™¨è¿è¡Œæ—¶æ£€æŸ¥
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>ğŸ³ å®¹å™¨è¿è¡Œæ—¶æ£€æŸ¥</h2>' >> "$REPORT_FILE"
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ”§ å®¹å™¨è¿è¡Œæ—¶</h3>' >> "$REPORT_FILE"
    
    if command -v docker >/dev/null 2>&1; then
        docker_version=$(docker --version 2>/dev/null)
        echo "<p><strong>Docker:</strong> <span class=\"status success\">$docker_version âœ…</span></p>" >> "$REPORT_FILE"
        if systemctl is-active --quiet docker; then
            echo '<p><strong>DockeræœåŠ¡:</strong> <span class="status success">è¿è¡Œä¸­ âœ…</span></p>' >> "$REPORT_FILE"
        else
            echo '<p><strong>DockeræœåŠ¡:</strong> <span class="status error">æœªè¿è¡Œ âŒ</span></p>' >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>Docker:</strong> <span class="status error">æœªå®‰è£… âŒ</span></p>' >> "$REPORT_FILE"
    fi
    
    if command -v containerd >/dev/null 2>&1; then
        containerd_version=$(containerd --version 2>/dev/null)
        echo "<p><strong>Containerd:</strong> <span class=\"status success\">$containerd_version âœ…</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>Containerd:</strong> <span class="status warning">æœªæ‰¾åˆ° âš ï¸</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # æ•°æ®ç›®å½•ä½ç½®æ£€æŸ¥
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>ğŸ“‚ æ•°æ®ç›®å½•ä½ç½®æ£€æŸ¥</h3>' >> "$REPORT_FILE"
    echo '<p>æ£€æŸ¥å…³é”®æœåŠ¡çš„æ•°æ®ç›®å½•æ˜¯å¦ä½äºæ¨èä½ç½®ï¼ˆé¿å…/homeç›®å½•ï¼‰:</p>' >> "$REPORT_FILE"
    
    # æ£€æŸ¥kubeletæ•°æ®ç›®å½•
    kubelet_data_dir="/var/lib/kubelet"
    if [ -d "$kubelet_data_dir" ]; then
        if [[ "$kubelet_data_dir" == /home/* ]]; then
            echo "<p><strong>kubeletæ•°æ®ç›®å½•:</strong> <span class=\"status warning\">$kubelet_data_dir (ä½äº/homeç›®å½•ï¼Œå»ºè®®è¿ç§») âš ï¸</span></p>" >> "$REPORT_FILE"
        else
            echo "<p><strong>kubeletæ•°æ®ç›®å½•:</strong> <span class=\"status success\">$kubelet_data_dir âœ…</span></p>" >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>kubeletæ•°æ®ç›®å½•:</strong> <span class="status error">æœªæ‰¾åˆ° âŒ</span></p>' >> "$REPORT_FILE"
    fi
    
    # æ£€æŸ¥containerdæ•°æ®ç›®å½•
    if command -v containerd >/dev/null 2>&1; then
        containerd_data_dir="/var/lib/containerd"
        if [ -d "$containerd_data_dir" ]; then
            if [[ "$containerd_data_dir" == /home/* ]]; then
                echo "<p><strong>containerdæ•°æ®ç›®å½•:</strong> <span class=\"status warning\">$containerd_data_dir (ä½äº/homeç›®å½•ï¼Œå»ºè®®è¿ç§») âš ï¸</span></p>" >> "$REPORT_FILE"
            else
                echo "<p><strong>containerdæ•°æ®ç›®å½•:</strong> <span class=\"status success\">$containerd_data_dir âœ…</span></p>" >> "$REPORT_FILE"
            fi
        else
            echo '<p><strong>containerdæ•°æ®ç›®å½•:</strong> <span class="status error">æœªæ‰¾åˆ° âŒ</span></p>' >> "$REPORT_FILE"
        fi
    fi
    
    # æ£€æŸ¥dockeræ•°æ®ç›®å½•
    if command -v docker >/dev/null 2>&1; then
        docker_data_dir=$(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo "/var/lib/docker")
        if [ -n "$docker_data_dir" ] && [ -d "$docker_data_dir" ]; then
            if [[ "$docker_data_dir" == /home/* ]]; then
                echo "<p><strong>Dockeræ•°æ®ç›®å½•:</strong> <span class=\"status warning\">$docker_data_dir (ä½äº/homeç›®å½•ï¼Œå»ºè®®è¿ç§») âš ï¸</span></p>" >> "$REPORT_FILE"
            else
                echo "<p><strong>Dockeræ•°æ®ç›®å½•:</strong> <span class=\"status success\">$docker_data_dir âœ…</span></p>" >> "$REPORT_FILE"
            fi
        else
            echo '<p><strong>Dockeræ•°æ®ç›®å½•:</strong> <span class="status error">æœªæ‰¾åˆ°æˆ–Dockeræœªè¿è¡Œ âŒ</span></p>' >> "$REPORT_FILE"
        fi
    fi
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # KubernetesèŠ‚ç‚¹çŠ¶æ€
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>â˜¸ï¸ KubernetesèŠ‚ç‚¹çŠ¶æ€</h2>' >> "$REPORT_FILE"
    echo '<div class="command-output">' >> "$REPORT_FILE"
    if command -v kubectl >/dev/null 2>&1; then
        kubectl get nodes $(hostname) -o wide 2>/dev/null || echo "æ— æ³•è·å–èŠ‚ç‚¹ä¿¡æ¯ - kubectlå¯èƒ½æœªé…ç½®" >> "$REPORT_FILE"
    else
        echo "æ­¤èŠ‚ç‚¹ä¸Škubectlä¸å¯ç”¨" >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # èµ„æºä½¿ç”¨æƒ…å†µ
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>ğŸ“ˆ å½“å‰èµ„æºä½¿ç”¨æƒ…å†µ</h2>' >> "$REPORT_FILE"
    echo '<div class="command-output">' >> "$REPORT_FILE"
    echo "=== CPUä½¿ç”¨ç‡ ===" >> "$REPORT_FILE"
    top -bn1 | head -5 >> "$REPORT_FILE"
    echo -e "\n=== å†…å­˜ä½¿ç”¨æƒ…å†µ ===" >> "$REPORT_FILE"
    free -h >> "$REPORT_FILE"
    echo -e "\n=== ç£ç›˜ä½¿ç”¨æƒ…å†µ ===" >> "$REPORT_FILE"
    df -h >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # é¡µè„š
    cat >> "$REPORT_FILE" << 'EOF'
        </div>
        <div class="footer">
            <p>ğŸ”§ CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥å®Œæˆäº $(date)</p>
            <p>ç”±Kubernetesé›†ç¾¤æ£€æŸ¥å·¥å…·ç”Ÿæˆ</p>
        </div>
    </div>
</body>
</html>
EOF

else
    # æ–‡æœ¬æ ¼å¼è¾“å‡º
    {
        echo "=== CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥æŠ¥å‘Š ==="
        echo "ä¸»æœºå: $(hostname)"
        echo "æ—¶é—´: $(date)"
        echo "æ“ä½œç³»ç»Ÿ: $(lsb_release -d 2>/dev/null | cut -f2 || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
        echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
        echo "ç³»ç»Ÿæ¶æ„: $(uname -m)"
        echo ""
        
        echo "=== ç³»ç»Ÿé…ç½®æ£€æŸ¥ ==="
        # Cgroupæ£€æŸ¥
        if [ -d /sys/fs/cgroup/unified ]; then
            echo "âœ… Cgroup: v2"
        elif [ -d /sys/fs/cgroup/memory ]; then
            echo "âš ï¸ Cgroup: v1 (å»ºè®®å‡çº§åˆ°v2)"
        else
            echo "âŒ Cgroup: æœªçŸ¥"
        fi
        
        # é˜²ç«å¢™æ£€æŸ¥
        if systemctl is-active --quiet firewalld; then
            echo "âŒ Firewalld: è¿è¡Œä¸­ (åº”å…³é—­)"
        else
            echo "âœ… Firewalld: å·²å…³é—­"
        fi
        
        if systemctl is-active --quiet ufw; then
            echo "âŒ UFW: è¿è¡Œä¸­ (åº”å…³é—­)"
        else
            echo "âœ… UFW: å·²å…³é—­"
        fi
        
        # SELinuxæ£€æŸ¥
        if command -v getenforce >/dev/null 2>&1; then
            selinux_status=$(getenforce 2>/dev/null)
            if [ "$selinux_status" = "Disabled" ]; then
                echo "âœ… SELinux: å·²ç¦ç”¨"
            else
                echo "âŒ SELinux: $selinux_status (åº”ç¦ç”¨)"
            fi
        else
            echo "âœ… SELinux: æœªå®‰è£…"
        fi
        
        # Swapæ£€æŸ¥
        swap_info=$(swapon --show 2>/dev/null)
        if [ -z "$swap_info" ]; then
            echo "âœ… Swap: å·²ç¦ç”¨"
        else
            echo "âŒ Swap: å¯ç”¨ä¸­ (åº”ç¦ç”¨)"
        fi
        
        # æ—¶åŒºæ£€æŸ¥
        current_timezone=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "unknown")
        if [ "$current_timezone" = "Asia/Shanghai" ]; then
            echo "âœ… æ—¶åŒº: Asia/Shanghai"
        else
            echo "âŒ æ—¶åŒº: $current_timezone (å»ºè®®è®¾ç½®ä¸ºAsia/Shanghai)"
        fi
        
        # æ—¶é—´åŒæ­¥æ£€æŸ¥
        if systemctl is-active --quiet chronyd; then
            echo "âœ… æ—¶é—´åŒæ­¥: Chronydè¿è¡Œä¸­"
        elif systemctl is-active --quiet ntp; then
            echo "âœ… æ—¶é—´åŒæ­¥: NTPè¿è¡Œä¸­"
        else
            echo "âŒ æ—¶é—´åŒæ­¥: æœªé…ç½®"
        fi
        echo ""
        
        echo "=== æ•°æ®ç›®å½•ä½ç½®æ£€æŸ¥ ==="
        # æ£€æŸ¥ kubelet æ•°æ®ç›®å½•
        kubelet_data_dir="/var/lib/kubelet"
        if [ -d "$kubelet_data_dir" ]; then
            if echo "$kubelet_data_dir" | grep -q "^/home"; then
                echo "âš ï¸ kubeletæ•°æ®ç›®å½•: $kubelet_data_dir (ä½äº/homeä¸‹ï¼Œå»ºè®®è¿ç§»)"
            else
                echo "âœ… kubeletæ•°æ®ç›®å½•: $kubelet_data_dir"
            fi
        else
            echo "âŒ kubeletæ•°æ®ç›®å½•: æœªæ‰¾åˆ°"
        fi
        
        # æ£€æŸ¥ containerd æ•°æ®ç›®å½•
        containerd_data_dir="/var/lib/containerd"
        if [ -d "$containerd_data_dir" ]; then
            if echo "$containerd_data_dir" | grep -q "^/home"; then
                echo "âš ï¸ containerdæ•°æ®ç›®å½•: $containerd_data_dir (ä½äº/homeä¸‹ï¼Œå»ºè®®è¿ç§»)"
            else
                echo "âœ… containerdæ•°æ®ç›®å½•: $containerd_data_dir"
            fi
        else
            echo "âŒ containerdæ•°æ®ç›®å½•: æœªæ‰¾åˆ°"
        fi
        
        # æ£€æŸ¥ docker æ•°æ®ç›®å½•
        if command -v docker >/dev/null 2>&1 && systemctl is-active --quiet docker; then
            docker_data_dir=$(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo "/var/lib/docker")
            if [ -d "$docker_data_dir" ]; then
                if echo "$docker_data_dir" | grep -q "^/home"; then
                    echo "âš ï¸ dockeræ•°æ®ç›®å½•: $docker_data_dir (ä½äº/homeä¸‹ï¼Œå»ºè®®è¿ç§»)"
                else
                    echo "âœ… dockeræ•°æ®ç›®å½•: $docker_data_dir"
                fi
            else
                echo "âŒ dockeræ•°æ®ç›®å½•: $docker_data_dir ä¸å­˜åœ¨"
            fi
        else
            echo "âŒ dockeræ•°æ®ç›®å½•: dockeræœªè¿è¡Œæˆ–æœªå®‰è£…"
        fi
        echo ""
        
        echo "=== Kubernetesè½¯ä»¶åŒ… ==="
        if command -v kubelet >/dev/null 2>&1; then
            kubelet_version=$(kubelet --version 2>/dev/null | awk '{print $2}')
            echo "âœ… kubelet: $kubelet_version"
        else
            echo "âŒ kubelet: æœªå®‰è£…"
        fi
        
        if command -v kubeadm >/dev/null 2>&1; then
            kubeadm_version=$(kubeadm version -o short 2>/dev/null)
            echo "âœ… kubeadm: $kubeadm_version"
        else
            echo "âŒ kubeadm: æœªå®‰è£…"
        fi
        
        if command -v kubectl >/dev/null 2>&1; then
            kubectl_version=$(kubectl version --client -o json 2>/dev/null | grep gitVersion | cut -d'"' -f4)
            echo "âœ… kubectl: $kubectl_version"
        else
            echo "âš ï¸ kubectl: æœªå®‰è£…"
        fi
        echo ""
        
        echo "=== å®¹å™¨è¿è¡Œæ—¶ ==="
        if command -v docker >/dev/null 2>&1; then
            docker_version=$(docker --version 2>/dev/null)
            echo "âœ… Docker: $docker_version"
            if systemctl is-active --quiet docker; then
                echo "âœ… DockeræœåŠ¡: è¿è¡Œä¸­"
            else
                echo "âŒ DockeræœåŠ¡: æœªè¿è¡Œ"
            fi
        else
            echo "âŒ Docker: æœªå®‰è£…"
        fi
        
        if command -v containerd >/dev/null 2>&1; then
            containerd_version=$(containerd --version 2>/dev/null)
            echo "âœ… Containerd: $containerd_version"
        else
            echo "âš ï¸ Containerd: æœªæ‰¾åˆ°"
        fi
        echo ""
        
        echo "=== ç³»ç»Ÿèµ„æº ==="
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "CPUå‹å·: $(grep -m1 'model name' /proc/cpuinfo | cut -d':' -f2 | xargs)"
        echo "æ€»å†…å­˜: $(free -h | awk '/^Mem:/ {print $2}')"
        echo "å¯ç”¨å†…å­˜: $(free -h | awk '/^Mem:/ {print $7}')"
        echo ""
        echo "æ£€æŸ¥å®Œæˆæ—¶é—´: $(date)"
    } > "$REPORT_FILE"
fi

echo "âœ… CPU WorkerèŠ‚ç‚¹å¥åº·æ£€æŸ¥å®Œæˆï¼"
echo "ğŸ“„ æŠ¥å‘Šå·²ä¿å­˜åˆ°: $REPORT_FILE"
