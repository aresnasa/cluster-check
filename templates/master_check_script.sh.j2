#!/bin/bash
# Master节点健康检查脚本

OUTPUT_FORMAT="${OUTPUT_FORMAT:-html}"
SIMPLIFIED_REPORT="${SIMPLIFIED_REPORT:-false}"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
HOSTNAME=$(hostname)
RESULTS_DIR="/tmp/cluster_check_results"
NODE_TYPE="${NODE_TYPE:-master}"

mkdir -p "$RESULTS_DIR"

if [ "$OUTPUT_FORMAT" = "html" ]; then
    if [ "$SIMPLIFIED_REPORT" = "true" ]; then
        REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_simplified_${TIMESTAMP}.html"
    else
        REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_${TIMESTAMP}.html"
    fi
else
    if [ "$SIMPLIFIED_REPORT" = "true" ]; then
        REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_simplified_${TIMESTAMP}.txt"
    else
        REPORT_FILE="$RESULTS_DIR/${HOSTNAME}_${NODE_TYPE}_check_${TIMESTAMP}.txt"
    fi
fi

echo "🎯 在$HOSTNAME上开始Master节点健康检查"
echo "📅 时间戳: $(date)"
echo "📂 报告将保存到: $REPORT_FILE"

# 生成HTML报告
if [ "$OUTPUT_FORMAT" = "html" ]; then
    if [ "$SIMPLIFIED_REPORT" = "true" ]; then
        # 简化HTML报告模式 - 只显示通过/失败状态
        cat > "$REPORT_FILE" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master节点健康检查报告 (简化版)</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 2em; font-weight: 300; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1em; }
        .content { padding: 20px; }
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .check-item:last-child { border-bottom: none; }
        .check-name { font-weight: 500; }
        .status { padding: 4px 12px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .footer { background: #f8f9fa; padding: 15px; text-align: center; color: #6c757d; border-top: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Master节点健康检查 (简化版)</h1>
            <p>主机: $(hostname) | 类型: Master | 生成时间: $(date)</p>
        </div>
        <div class="content">
EOF

    # 添加简化检查项目
    echo '<div class="check-item"><span class="check-name">系统配置检查</span>' >> "$REPORT_FILE"
    
    # Cgroup版本检查
    if [ -d /sys/fs/cgroup/unified ]; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    elif [ -d /sys/fs/cgroup/memory ]; then
        echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # 防火墙状态检查
    echo '<div class="check-item"><span class="check-name">防火墙状态</span>' >> "$REPORT_FILE"
    if ! systemctl is-active --quiet firewalld && ! systemctl is-active --quiet ufw; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # SELinux检查
    echo '<div class="check-item"><span class="check-name">SELinux状态</span>' >> "$REPORT_FILE"
    if command -v getenforce >/dev/null 2>&1; then
        selinux_status=$(getenforce 2>/dev/null)
        if [ "$selinux_status" = "Disabled" ]; then
            echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
        else
            echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
        fi
    else
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    fi
    
    # Swap检查
    echo '<div class="check-item"><span class="check-name">Swap状态</span>' >> "$REPORT_FILE"
    swap_info=$(swapon --show 2>/dev/null)
    if [ -z "$swap_info" ]; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # 时区检查
    echo '<div class="check-item"><span class="check-name">时区配置</span>' >> "$REPORT_FILE"
    current_timezone=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "unknown")
    if [ "$current_timezone" = "Asia/Shanghai" ]; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # 时间同步检查
    echo '<div class="check-item"><span class="check-name">时间同步</span>' >> "$REPORT_FILE"
    if systemctl is-active --quiet chronyd || systemctl is-active --quiet ntp; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # Kubernetes软件包检查
    echo '<div class="check-item"><span class="check-name">kubelet安装</span>' >> "$REPORT_FILE"
    if command -v kubelet >/dev/null 2>&1; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    echo '<div class="check-item"><span class="check-name">kubeadm安装</span>' >> "$REPORT_FILE"
    if command -v kubeadm >/dev/null 2>&1; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    echo '<div class="check-item"><span class="check-name">kubectl安装</span>' >> "$REPORT_FILE"
    if command -v kubectl >/dev/null 2>&1; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
    fi
    
    # 数据目录位置检查
    echo '<div class="check-item"><span class="check-name">kubelet数据目录</span>' >> "$REPORT_FILE"
    kubelet_data_dir="/var/lib/kubelet"
    if [ -d "$kubelet_data_dir" ] && ! echo "$kubelet_data_dir" | grep -q "^/home"; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    elif [ -d "$kubelet_data_dir" ]; then
        echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    echo '<div class="check-item"><span class="check-name">containerd数据目录</span>' >> "$REPORT_FILE"
    containerd_data_dir="/var/lib/containerd"
    if [ -d "$containerd_data_dir" ] && ! echo "$containerd_data_dir" | grep -q "^/home"; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    elif [ -d "$containerd_data_dir" ]; then
        echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    echo '<div class="check-item"><span class="check-name">docker数据目录</span>' >> "$REPORT_FILE"
    if command -v docker >/dev/null 2>&1 && systemctl is-active --quiet docker; then
        docker_data_dir=$(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo "/var/lib/docker")
        if [ -d "$docker_data_dir" ] && ! echo "$docker_data_dir" | grep -q "^/home"; then
            echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
        elif [ -d "$docker_data_dir" ]; then
            echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
        else
            echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
        fi
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    echo '<div class="check-item"><span class="check-name">etcd数据目录</span>' >> "$REPORT_FILE"
    etcd_data_dir="/var/lib/etcd"
    if [ -d "$etcd_data_dir" ] && ! echo "$etcd_data_dir" | grep -q "^/home"; then
        echo '<span class="status success">通过</span></div>' >> "$REPORT_FILE"
    elif [ -d "$etcd_data_dir" ]; then
        echo '<span class="status warning">警告</span></div>' >> "$REPORT_FILE"
    else
        echo '<span class="status error">失败</span></div>' >> "$REPORT_FILE"
    fi
    
    # 添加页脚
    cat >> "$REPORT_FILE" << 'EOF'
        </div>
        <div class="footer">
            <p>🔍 Master节点健康检查 (简化版) 完成于 $(date)</p>
            <p>由Kubernetes集群检查工具生成</p>
        </div>
    </div>
</body>
</html>
EOF

    else
        # 完整HTML报告模式
        cat > "$REPORT_FILE" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master节点健康检查报告</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1em; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section h2 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; }
        .info-card h3 { margin: 0 0 10px 0; color: #495057; }
        .status { padding: 4px 12px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .command-output { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; overflow-x: auto; }
        .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; border-top: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Master节点健康检查</h1>
            <p>节点: $(hostname) | 时间: $(date)</p>
        </div>
        <div class="content">
EOF

    # 基本信息检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>📋 基本信息</h2>' >> "$REPORT_FILE"
    echo '<div class="info-grid">' >> "$REPORT_FILE"
    
    # 主机名信息
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🖥️ 主机信息</h3>' >> "$REPORT_FILE"
    echo "<p><strong>主机名:</strong> $(hostname)</p>" >> "$REPORT_FILE"
    echo "<p><strong>内核版本:</strong> $(uname -r)</p>" >> "$REPORT_FILE"
    echo "<p><strong>操作系统:</strong> $(uname -o)</p>" >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # 运行时间
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>⏰ 系统运行状态</h3>' >> "$REPORT_FILE"
    echo "<p><strong>系统运行时间:</strong> $(uptime)</p>" >> "$REPORT_FILE"
    echo "<p><strong>检查时间:</strong> $(date)</p>" >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # Kubernetes检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>☸️ Kubernetes检查</h2>' >> "$REPORT_FILE"
    
    # kubectl检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🔧 kubectl状态</h3>' >> "$REPORT_FILE"
    if command -v kubectl >/dev/null 2>&1; then
        echo '<p><strong>kubectl:</strong> <span class="status success">可用</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== kubectl 版本信息 ===" >> "$REPORT_FILE"
        kubectl version --client 2>/dev/null || echo "无法获取kubectl版本" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>kubectl:</strong> <span class="status error">不可用</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 集群连接检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🌐 集群连接</h3>' >> "$REPORT_FILE"
    if kubectl cluster-info >/dev/null 2>&1; then
        echo '<p><strong>集群连接:</strong> <span class="status success">正常</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== 集群信息 ===" >> "$REPORT_FILE"
        kubectl cluster-info 2>/dev/null || echo "无法获取集群信息" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>集群连接:</strong> <span class="status error">失败</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # etcd版本和状态检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🗄️ etcd检查</h3>' >> "$REPORT_FILE"
    
    # 检查etcd进程
    if systemctl is-active --quiet etcd; then
        echo '<p><strong>etcd服务:</strong> <span class="status success">运行中</span></p>' >> "$REPORT_FILE"
        etcd_version=$(etcd --version 2>/dev/null | head -1 | awk '{print $3}' || echo "未知")
        echo "<p><strong>etcd版本:</strong> $etcd_version</p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>etcd服务:</strong> <span class="status warning">未运行或使用Pod模式</span></p>' >> "$REPORT_FILE"
        
        # 检查etcd Pod
        if kubectl get pods -n kube-system -l component=etcd >/dev/null 2>&1; then
            echo '<p><strong>etcd Pod模式:</strong> <span class="status success">检测到</span></p>' >> "$REPORT_FILE"
            echo '<div class="command-output">' >> "$REPORT_FILE"
            echo "=== etcd Pod状态 ===" >> "$REPORT_FILE"
            kubectl get pods -n kube-system -l component=etcd -o wide 2>/dev/null || echo "无法获取etcd Pod信息" >> "$REPORT_FILE"
            echo '</div>' >> "$REPORT_FILE"
        else
            echo '<p><strong>etcd状态:</strong> <span class="status error">未找到</span></p>' >> "$REPORT_FILE"
        fi
    fi
    
    # etcd健康检查
    if command -v etcdctl >/dev/null 2>&1; then
        echo '<p><strong>etcdctl:</strong> <span class="status success">可用</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== etcd集群健康检查 ===" >> "$REPORT_FILE"
        ETCDCTL_API=3 etcdctl endpoint health 2>/dev/null || echo "etcd健康检查失败 - 可能需要证书配置" >> "$REPORT_FILE"
        echo -e "\n=== etcd成员列表 ===" >> "$REPORT_FILE"
        ETCDCTL_API=3 etcdctl member list 2>/dev/null || echo "获取etcd成员列表失败" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>etcdctl:</strong> <span class="status warning">不可用</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    
    # Master节点系统配置检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>🔧 Master节点系统配置检查</h2>' >> "$REPORT_FILE"
    
    # Cgroup版本检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>📁 Cgroup版本检查</h3>' >> "$REPORT_FILE"
    if [ -d /sys/fs/cgroup/unified ]; then
        echo '<p><strong>Cgroup版本:</strong> <span class="status success">Cgroup v2</span></p>' >> "$REPORT_FILE"
    elif [ -d /sys/fs/cgroup/memory ]; then
        echo '<p><strong>Cgroup版本:</strong> <span class="status warning">Cgroup v1</span></p>' >> "$REPORT_FILE"
        echo '<p>建议：现代Kubernetes版本推荐使用Cgroup v2</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Cgroup版本:</strong> <span class="status error">未知</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 防火墙状态检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🔥 防火墙状态检查</h3>' >> "$REPORT_FILE"
    if systemctl is-active --quiet firewalld; then
        echo '<p><strong>Firewalld:</strong> <span class="status error">运行中 ❌</span></p>' >> "$REPORT_FILE"
        echo '<p>❗ 警告：防火墙应该关闭以避免Kubernetes网络问题</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Firewalld:</strong> <span class="status success">已关闭 ✅</span></p>' >> "$REPORT_FILE"
    fi
    
    if systemctl is-active --quiet ufw; then
        echo '<p><strong>UFW:</strong> <span class="status error">运行中 ❌</span></p>' >> "$REPORT_FILE"
        echo '<p>❗ 警告：UFW防火墙应该关闭</p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>UFW:</strong> <span class="status success">已关闭 ✅</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # SELinux状态检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🔒 SELinux状态检查</h3>' >> "$REPORT_FILE"
    if command -v getenforce >/dev/null 2>&1; then
        selinux_status=$(getenforce 2>/dev/null)
        if [ "$selinux_status" = "Disabled" ]; then
            echo '<p><strong>SELinux:</strong> <span class="status success">已禁用 ✅</span></p>' >> "$REPORT_FILE"
        else
            echo "<p><strong>SELinux:</strong> <span class=\"status error\">$selinux_status ❌</span></p>" >> "$REPORT_FILE"
            echo '<p>❗ 警告：SELinux应该禁用以避免Kubernetes权限问题</p>' >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>SELinux:</strong> <span class="status success">未安装 ✅</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # Swap检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>💽 Swap状态检查</h3>' >> "$REPORT_FILE"
    swap_info=$(swapon --show 2>/dev/null)
    if [ -z "$swap_info" ]; then
        echo '<p><strong>Swap:</strong> <span class="status success">已禁用 ✅</span></p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>Swap:</strong> <span class="status error">启用中 ❌</span></p>' >> "$REPORT_FILE"
        echo '<p>❗ 警告：Kubernetes要求禁用Swap</p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "$swap_info" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 时区和NTP检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🕐 时区和时间同步检查</h3>' >> "$REPORT_FILE"
    current_timezone=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "unknown")
    if [ "$current_timezone" = "Asia/Shanghai" ]; then
        echo '<p><strong>时区:</strong> <span class="status success">Asia/Shanghai ✅</span></p>' >> "$REPORT_FILE"
    else
        echo "<p><strong>时区:</strong> <span class=\"status error\">$current_timezone ❌</span></p>" >> "$REPORT_FILE"
        echo '<p>❗ 警告：建议设置时区为Asia/Shanghai</p>' >> "$REPORT_FILE"
    fi
    
    if systemctl is-active --quiet chronyd; then
        echo '<p><strong>Chronyd:</strong> <span class="status success">运行中 ✅</span></p>' >> "$REPORT_FILE"
    elif systemctl is-active --quiet ntp; then
        echo '<p><strong>NTP:</strong> <span class="status success">运行中 ✅</span></p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>时间同步:</strong> <span class="status error">未配置 ❌</span></p>' >> "$REPORT_FILE"
        echo '<p>❗ 警告：建议配置Chronyd或NTP进行时间同步</p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 内核参数检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>⚙️ Kubernetes内核参数检查</h3>' >> "$REPORT_FILE"
    echo '<p>检查 /etc/sysctl.d/k8s.conf 中的关键参数:</p>' >> "$REPORT_FILE"
    
    # 检查关键内核参数
    check_sysctl_param() {
        local param=$1
        local expected=$2
        local current=$(sysctl -n $param 2>/dev/null)
        if [ "$current" = "$expected" ]; then
            echo "<p><strong>$param:</strong> <span class=\"status success\">$current ✅</span></p>" >> "$REPORT_FILE"
        else
            echo "<p><strong>$param:</strong> <span class=\"status error\">$current (期望: $expected) ❌</span></p>" >> "$REPORT_FILE"
        fi
    }
    
    check_sysctl_param "net.bridge.bridge-nf-call-ip6tables" "1"
    check_sysctl_param "net.bridge.bridge-nf-call-iptables" "1"
    check_sysctl_param "net.ipv4.ip_forward" "1"
    check_sysctl_param "vm.swappiness" "0"
    check_sysctl_param "net.ipv4.conf.default.rp_filter" "1"
    check_sysctl_param "net.ipv4.conf.all.rp_filter" "1"
    
    if [ -f /etc/sysctl.d/k8s.conf ]; then
        echo '<p><strong>配置文件:</strong> <span class="status success">/etc/sysctl.d/k8s.conf 存在 ✅</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== /etc/sysctl.d/k8s.conf 内容 ===" >> "$REPORT_FILE"
        cat /etc/sysctl.d/k8s.conf >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>配置文件:</strong> <span class="status error">/etc/sysctl.d/k8s.conf 不存在 ❌</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # Kubernetes软件包检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>📦 Kubernetes软件包检查</h3>' >> "$REPORT_FILE"
    
    # 检查kubelet
    if command -v kubelet >/dev/null 2>&1; then
        kubelet_version=$(kubelet --version 2>/dev/null | awk '{print $2}')
        echo "<p><strong>kubelet:</strong> <span class=\"status success\">$kubelet_version ✅</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubelet:</strong> <span class="status error">未安装 ❌</span></p>' >> "$REPORT_FILE"
    fi
    
    # 检查kubeadm
    if command -v kubeadm >/dev/null 2>&1; then
        kubeadm_version=$(kubeadm version -o short 2>/dev/null)
        echo "<p><strong>kubeadm:</strong> <span class=\"status success\">$kubeadm_version ✅</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubeadm:</strong> <span class="status error">未安装 ❌</span></p>' >> "$REPORT_FILE"
    fi
    
    # 检查kubectl
    if command -v kubectl >/dev/null 2>&1; then
        kubectl_version=$(kubectl version --client -o json 2>/dev/null | grep gitVersion | cut -d'"' -f4)
        echo "<p><strong>kubectl:</strong> <span class=\"status success\">$kubectl_version ✅</span></p>" >> "$REPORT_FILE"
    else
        echo '<p><strong>kubectl:</strong> <span class="status warning">未安装 ⚠️</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 数据目录位置检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>📂 数据目录位置检查</h3>' >> "$REPORT_FILE"
    echo '<p>检查关键服务的数据目录是否位于推荐位置（避免/home目录）:</p>' >> "$REPORT_FILE"
    
    # 检查kubelet数据目录
    kubelet_data_dir="/var/lib/kubelet"
    if [ -d "$kubelet_data_dir" ]; then
        if [[ "$kubelet_data_dir" == /home/* ]]; then
            echo "<p><strong>kubelet数据目录:</strong> <span class=\"status warning\">$kubelet_data_dir (位于/home目录，建议迁移) ⚠️</span></p>" >> "$REPORT_FILE"
        else
            echo "<p><strong>kubelet数据目录:</strong> <span class=\"status success\">$kubelet_data_dir ✅</span></p>" >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>kubelet数据目录:</strong> <span class="status error">未找到 ❌</span></p>' >> "$REPORT_FILE"
    fi
    
    # 检查containerd数据目录
    if command -v containerd >/dev/null 2>&1; then
        containerd_data_dir="/var/lib/containerd"
        if [ -d "$containerd_data_dir" ]; then
            if [[ "$containerd_data_dir" == /home/* ]]; then
                echo "<p><strong>containerd数据目录:</strong> <span class=\"status warning\">$containerd_data_dir (位于/home目录，建议迁移) ⚠️</span></p>" >> "$REPORT_FILE"
            else
                echo "<p><strong>containerd数据目录:</strong> <span class=\"status success\">$containerd_data_dir ✅</span></p>" >> "$REPORT_FILE"
            fi
        else
            echo '<p><strong>containerd数据目录:</strong> <span class="status error">未找到 ❌</span></p>' >> "$REPORT_FILE"
        fi
    fi
    
    # 检查docker数据目录
    if command -v docker >/dev/null 2>&1; then
        docker_data_dir=$(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo "/var/lib/docker")
        if [ -n "$docker_data_dir" ] && [ -d "$docker_data_dir" ]; then
            if [[ "$docker_data_dir" == /home/* ]]; then
                echo "<p><strong>Docker数据目录:</strong> <span class=\"status warning\">$docker_data_dir (位于/home目录，建议迁移) ⚠️</span></p>" >> "$REPORT_FILE"
            else
                echo "<p><strong>Docker数据目录:</strong> <span class=\"status success\">$docker_data_dir ✅</span></p>" >> "$REPORT_FILE"
            fi
        else
            echo '<p><strong>Docker数据目录:</strong> <span class="status error">未找到或Docker未运行 ❌</span></p>' >> "$REPORT_FILE"
        fi
    fi
    
    # 检查etcd数据目录
    etcd_data_dir="/var/lib/etcd"
    if [ -d "$etcd_data_dir" ]; then
        if [[ "$etcd_data_dir" == /home/* ]]; then
            echo "<p><strong>etcd数据目录:</strong> <span class=\"status warning\">$etcd_data_dir (位于/home目录，建议迁移) ⚠️</span></p>" >> "$REPORT_FILE"
        else
            echo "<p><strong>etcd数据目录:</strong> <span class=\"status success\">$etcd_data_dir ✅</span></p>" >> "$REPORT_FILE"
        fi
    else
        echo '<p><strong>etcd数据目录:</strong> <span class="status error">未找到 ❌</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    
    # Master节点特有检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>👑 Master节点特有检查</h2>' >> "$REPORT_FILE"
    
    # kube-apiserver检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🔗 kube-apiserver状态</h3>' >> "$REPORT_FILE"
    if kubectl get pods -n kube-system -l component=kube-apiserver >/dev/null 2>&1; then
        echo '<p><strong>kube-apiserver:</strong> <span class="status success">运行中</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== kube-apiserver Pod状态 ===" >> "$REPORT_FILE"
        kubectl get pods -n kube-system -l component=kube-apiserver -o wide 2>/dev/null || echo "无法获取apiserver Pod信息" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>kube-apiserver:</strong> <span class="status error">状态异常</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # kube-controller-manager检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🎮 kube-controller-manager状态</h3>' >> "$REPORT_FILE"
    if kubectl get pods -n kube-system -l component=kube-controller-manager >/dev/null 2>&1; then
        echo '<p><strong>kube-controller-manager:</strong> <span class="status success">运行中</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== kube-controller-manager Pod状态 ===" >> "$REPORT_FILE"
        kubectl get pods -n kube-system -l component=kube-controller-manager -o wide 2>/dev/null || echo "无法获取controller-manager Pod信息" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>kube-controller-manager:</strong> <span class="status error">状态异常</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # kube-scheduler检查
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>📅 kube-scheduler状态</h3>' >> "$REPORT_FILE"
    if kubectl get pods -n kube-system -l component=kube-scheduler >/dev/null 2>&1; then
        echo '<p><strong>kube-scheduler:</strong> <span class="status success">运行中</span></p>' >> "$REPORT_FILE"
        echo '<div class="command-output">' >> "$REPORT_FILE"
        echo "=== kube-scheduler Pod状态 ===" >> "$REPORT_FILE"
        kubectl get pods -n kube-system -l component=kube-scheduler -o wide 2>/dev/null || echo "无法获取scheduler Pod信息" >> "$REPORT_FILE"
        echo '</div>' >> "$REPORT_FILE"
    else
        echo '<p><strong>kube-scheduler:</strong> <span class="status error">状态异常</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    
    # 网络组件检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>🌐 网络组件检查</h2>' >> "$REPORT_FILE"
    
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🔗 CNI网络插件</h3>' >> "$REPORT_FILE"
    echo '<div class="command-output">' >> "$REPORT_FILE"
    echo "=== CNI Pod状态 ===" >> "$REPORT_FILE"
    kubectl get pods -n kube-system -l app=calico-node 2>/dev/null || \
    kubectl get pods -n kube-system -l app=flannel 2>/dev/null || \
    kubectl get pods -n kube-system -l app=weave-net 2>/dev/null || \
    echo "未检测到常见CNI插件 (Calico, Flannel, Weave)" >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    
    # 系统资源检查
    echo '<div class="section">' >> "$REPORT_FILE"
    echo '<h2>📊 系统资源</h2>' >> "$REPORT_FILE"
    echo '<div class="info-grid">' >> "$REPORT_FILE"
    
    # CPU信息
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>🖥️ CPU信息</h3>' >> "$REPORT_FILE"
    if [ -f /proc/cpuinfo ]; then
        cpu_count=$(nproc)
        cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
        echo "<p><strong>CPU核心数:</strong> $cpu_count</p>" >> "$REPORT_FILE"
        echo "<p><strong>CPU型号:</strong> $cpu_model</p>" >> "$REPORT_FILE"
        echo '<p><strong>CPU状态:</strong> <span class="status success">正常</span></p>' >> "$REPORT_FILE"
    else
        echo '<p><strong>CPU信息:</strong> <span class="status warning">无法获取</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    # 内存信息
    echo '<div class="info-card">' >> "$REPORT_FILE"
    echo '<h3>💾 内存信息</h3>' >> "$REPORT_FILE"
    if [ -f /proc/meminfo ]; then
        total_mem=$(grep "MemTotal" /proc/meminfo | awk '{print $2}')
        available_mem=$(grep "MemAvailable" /proc/meminfo | awk '{print $2}')
        if [ -n "$total_mem" ] && [ -n "$available_mem" ]; then
            total_gb=$((total_mem / 1024 / 1024))
            available_gb=$((available_mem / 1024 / 1024))
            used_percent=$(( (total_mem - available_mem) * 100 / total_mem ))
            echo "<p><strong>总内存:</strong> ${total_gb}GB</p>" >> "$REPORT_FILE"
            echo "<p><strong>可用内存:</strong> ${available_gb}GB</p>" >> "$REPORT_FILE"
            echo "<p><strong>内存使用率:</strong> ${used_percent}%</p>" >> "$REPORT_FILE"
            if [ "$used_percent" -lt 80 ]; then
                echo '<p><strong>内存状态:</strong> <span class="status success">正常</span></p>' >> "$REPORT_FILE"
            else
                echo '<p><strong>内存状态:</strong> <span class="status warning">使用率偏高</span></p>' >> "$REPORT_FILE"
            fi
        fi
    else
        echo '<p><strong>内存信息:</strong> <span class="status warning">无法获取</span></p>' >> "$REPORT_FILE"
    fi
    echo '</div>' >> "$REPORT_FILE"
    
    echo '</div>' >> "$REPORT_FILE"
    echo '</div>' >> "$REPORT_FILE"
    
    # 页脚
    cat >> "$REPORT_FILE" << 'EOF'
        </div>
        <div class="footer">
            <p>🎯 Master节点健康检查完成</p>
            <p>由Kubernetes集群检查工具生成</p>
        </div>
    </div>
</body>
</html>
EOF

else
    # 文本格式输出
    {
        echo "=== Master节点健康检查报告 ==="
        echo "主机名: $(hostname)"
        echo "时间: $(date)"
        echo "内核版本: $(uname -r)"
        echo "操作系统: $(lsb_release -d 2>/dev/null | cut -f2 || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
        echo ""
        
        echo "=== Kubernetes检查 ==="
        if command -v kubectl >/dev/null 2>&1; then
            echo "✅ kubectl: 可用"
            kubectl version --client 2>/dev/null || echo "⚠️ 无法获取kubectl版本"
            if kubectl cluster-info >/dev/null 2>&1; then
                echo "✅ 集群连接: 正常"
            else
                echo "❌ 集群连接: 失败"
            fi
        else
            echo "❌ kubectl: 不可用"
        fi
        echo ""
        
        echo "=== etcd检查 ==="
        if systemctl is-active --quiet etcd; then
            echo "✅ etcd服务: 运行中"
            etcd_version=$(etcd --version 2>/dev/null | head -1 | awk '{print $3}' || echo "未知")
            echo "etcd版本: $etcd_version"
        else
            echo "⚠️ etcd服务: 未运行或使用Pod模式"
            if kubectl get pods -n kube-system -l component=etcd >/dev/null 2>&1; then
                echo "✅ etcd Pod模式: 检测到"
            else
                echo "❌ etcd状态: 未找到"
            fi
        fi
        if command -v etcdctl >/dev/null 2>&1; then
            echo "✅ etcdctl: 可用"
        else
            echo "⚠️ etcdctl: 不可用"
        fi
        echo ""
        
        echo "=== 系统配置检查 ==="
        # Cgroup检查
        if [ -d /sys/fs/cgroup/unified ]; then
            echo "✅ Cgroup: v2"
        elif [ -d /sys/fs/cgroup/memory ]; then
            echo "⚠️ Cgroup: v1 (建议升级到v2)"
        else
            echo "❌ Cgroup: 未知"
        fi
        
        # 防火墙检查
        if systemctl is-active --quiet firewalld; then
            echo "❌ Firewalld: 运行中 (应关闭)"
        else
            echo "✅ Firewalld: 已关闭"
        fi
        
        if systemctl is-active --quiet ufw; then
            echo "❌ UFW: 运行中 (应关闭)"
        else
            echo "✅ UFW: 已关闭"
        fi
        
        # SELinux检查
        if command -v getenforce >/dev/null 2>&1; then
            selinux_status=$(getenforce 2>/dev/null)
            if [ "$selinux_status" = "Disabled" ]; then
                echo "✅ SELinux: 已禁用"
            else
                echo "❌ SELinux: $selinux_status (应禁用)"
            fi
        else
            echo "✅ SELinux: 未安装"
        fi
        
        # Swap检查
        swap_info=$(swapon --show 2>/dev/null)
        if [ -z "$swap_info" ]; then
            echo "✅ Swap: 已禁用"
        else
            echo "❌ Swap: 启用中 (应禁用)"
        fi
        
        # 时区检查
        current_timezone=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "unknown")
        if [ "$current_timezone" = "Asia/Shanghai" ]; then
            echo "✅ 时区: Asia/Shanghai"
        else
            echo "❌ 时区: $current_timezone (建议设置为Asia/Shanghai)"
        fi
        
        # 时间同步检查
        if systemctl is-active --quiet chronyd; then
            echo "✅ 时间同步: Chronyd运行中"
        elif systemctl is-active --quiet ntp; then
            echo "✅ 时间同步: NTP运行中"
        else
            echo "❌ 时间同步: 未配置"
        fi
        echo ""
        
        echo "=== Kubernetes软件包 ==="
        if command -v kubelet >/dev/null 2>&1; then
            kubelet_version=$(kubelet --version 2>/dev/null | awk '{print $2}')
            echo "✅ kubelet: $kubelet_version"
        else
            echo "❌ kubelet: 未安装"
        fi
        
        if command -v kubeadm >/dev/null 2>&1; then
            kubeadm_version=$(kubeadm version -o short 2>/dev/null)
            echo "✅ kubeadm: $kubeadm_version"
        else
            echo "❌ kubeadm: 未安装"
        fi
        
        if command -v kubectl >/dev/null 2>&1; then
            kubectl_version=$(kubectl version --client -o json 2>/dev/null | grep gitVersion | cut -d'"' -f4)
            echo "✅ kubectl: $kubectl_version"
        else
            echo "⚠️ kubectl: 未安装"
        fi
        echo ""
        
        echo "=== 数据目录位置检查 ==="
        # 检查kubelet数据目录
        kubelet_data_dir="/var/lib/kubelet"
        if [ -d "$kubelet_data_dir" ]; then
            if [[ "$kubelet_data_dir" == /home/* ]]; then
                echo "⚠️ kubelet数据目录: $kubelet_data_dir (位于/home目录，建议迁移)"
            else
                echo "✅ kubelet数据目录: $kubelet_data_dir"
            fi
        else
            echo "❌ kubelet数据目录: 未找到"
        fi
        
        # 检查containerd数据目录
        if command -v containerd >/dev/null 2>&1; then
            containerd_data_dir="/var/lib/containerd"
            if [ -d "$containerd_data_dir" ]; then
                if [[ "$containerd_data_dir" == /home/* ]]; then
                    echo "⚠️ containerd数据目录: $containerd_data_dir (位于/home目录，建议迁移)"
                else
                    echo "✅ containerd数据目录: $containerd_data_dir"
                fi
            else
                echo "❌ containerd数据目录: 未找到"
            fi
        fi
        
        # 检查docker数据目录
        if command -v docker >/dev/null 2>&1; then
            docker_data_dir=$(docker info --format '{{.DockerRootDir}}' 2>/dev/null || echo "/var/lib/docker")
            if [ -n "$docker_data_dir" ] && [ -d "$docker_data_dir" ]; then
                if [[ "$docker_data_dir" == /home/* ]]; then
                    echo "⚠️ Docker数据目录: $docker_data_dir (位于/home目录，建议迁移)"
                else
                    echo "✅ Docker数据目录: $docker_data_dir"
                fi
            else
                echo "❌ Docker数据目录: 未找到或Docker未运行"
            fi
        fi
        
        # 检查etcd数据目录
        etcd_data_dir="/var/lib/etcd"
        if [ -d "$etcd_data_dir" ]; then
            if [[ "$etcd_data_dir" == /home/* ]]; then
                echo "⚠️ etcd数据目录: $etcd_data_dir (位于/home目录，建议迁移)"
            else
                echo "✅ etcd数据目录: $etcd_data_dir"
            fi
        else
            echo "❌ etcd数据目录: 未找到"
        fi
        echo ""
        
        echo "=== Master节点组件 ==="
        if kubectl get pods -n kube-system -l component=kube-apiserver >/dev/null 2>&1; then
            echo "✅ kube-apiserver: 运行中"
        else
            echo "❌ kube-apiserver: 状态异常"
        fi
        
        if kubectl get pods -n kube-system -l component=kube-controller-manager >/dev/null 2>&1; then
            echo "✅ kube-controller-manager: 运行中"
        else
            echo "❌ kube-controller-manager: 状态异常"
        fi
        
        if kubectl get pods -n kube-system -l component=kube-scheduler >/dev/null 2>&1; then
            echo "✅ kube-scheduler: 运行中"
        else
            echo "❌ kube-scheduler: 状态异常"
        fi
        echo ""
        
        echo "=== 系统资源 ==="
        echo "CPU核心数: $(nproc)"
        if [ -f /proc/meminfo ]; then
            total_mem=$(grep "MemTotal" /proc/meminfo | awk '{print $2}')
            total_gb=$((total_mem / 1024 / 1024))
            echo "总内存: ${total_gb}GB"
        fi
        echo ""
        echo "检查完成时间: $(date)"
    } > "$REPORT_FILE"
fi

echo "✅ Master节点检查完成，报告已保存到: $REPORT_FILE"
